<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.platform.modules.qkj.dao.QkjRSonorderDao">

    <sql id="selectSql">
        SELECT
        IFNULL(sendnum,0) as sendnum,IFNULL(rate,0) as rate,IFNULL(pronum,0) as pronum,IFNULL(num,0) as num,
        T.*,l.*,IFNULL(m.FName_L2,'空') as fnameL2,m.FBaseUnit,m.Fmodel as fmodel,
        (IFNULL(t.num,0)-IFNULL(t.sendnum,0)) as bnum
        FROM QKJ_R_SONORDER T
        left join qkj_r_orderlogi l on (t.rgid=l.id)
        left join qkj_r_material m on (t.materielid=m.fid)
        WHERE 1=1
        <if test="params.name != null and params.name.trim() != ''">
            AND T.NAME LIKE '%${params.name}%'
        </if>
        <if test="params.orderid != null and params.orderid.trim() != ''">
            AND T.orderid='${params.orderid}'
        </if>
        <if test="params.rgstate != null">
            AND T.rgstate=${params.rgstate}
        </if>
        <if test="params.sendstate != null">
            AND T.sendstate=${params.sendstate}
        </if>

        <if test="params.sendstateed != null"><!--查询发货数量小于预订数量的-->
            AND IFNULL(t.sendnum,0)&lt; IFNULL(t.num,0)
        </if>


        <if test="params.selectsendstate != null">
            AND T.sendstate>=0 AND  T.sendstate  &lt;2
        </if>



    </sql>

    <select id="selectQkjRSonorderPage" resultType="com.platform.modules.qkj.entity.QkjRSonorderEntity">
        <include refid="selectSql"/>
    </select>

    <select id="queryAll" resultType="com.platform.modules.qkj.entity.QkjRSonorderEntity">
        <include refid="selectSql"/>
    </select>

    <update id="updateSendnumById" parameterType="com.platform.modules.qkj.entity.QkjRSonorderEntity">
		UPDATE QKJ_R_SONORDER SET sendnum = IfNULL((SELECT sum(num) from qkj_r_orderlogidetail where materid=#{id}),0)
        WHERE id = #{id}
	</update>

    <update id="updatePornumById" parameterType="com.platform.modules.qkj.entity.QkjRSonorderEntity">
		UPDATE QKJ_R_SONORDER SET pronum = #{pronum},sendstate=#{sendstate} WHERE id = #{id}
	</update>

    <update id="updatePornumByIdnew" parameterType="com.platform.modules.qkj.entity.QkjRSonorderEntity">
		UPDATE QKJ_R_SONORDER SET pronum = #{pronum},sendstate=#{sendstate} WHERE id = #{id}
	</update>

    <update id="updateRateById" parameterType="com.platform.modules.qkj.entity.QkjRSonorderEntity">
		UPDATE QKJ_R_SONORDER SET rate = #{rate},rgstate=#{rgstate} WHERE id = #{id}
	</update>

    <update id="updateSonbyOAndM" parameterType="com.platform.modules.qkj.entity.QkjRSonorderEntity">
		UPDATE QKJ_R_SONORDER SET rgnum = #{rgnum},rgstate=#{rgstate},
		rate=
		CASE when #{rgnum} &lt; sendnum then
        ROUND(CAST((#{rgnum}/sendnum) AS DECIMAL(5,2))*100,2)
        else
        100 end
		 WHERE orderid = #{orderid} and materielid=#{materielid}
	</update>

    <delete id="deletebyOrderAndId">
        DELETE FROM QKJ_R_SONORDER WHERE orderid=#{orderid} and id IN
        <foreach item="ids" collection="array" open="(" separator="," close=")">
            #{ids}
        </foreach>
    </delete>
</mapper>