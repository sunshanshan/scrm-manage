<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.platform.modules.qkj.dao.QkjROrderDao">

    <sql id="selectSql">
        SELECT T.*,u.REAL_NAME as realname,u.user_name logintitle,addu.REAL_NAME as agentname,
        cheu.REAL_NAME as approvername,SUBSTR(t.stsdate,1,10) as stsdatel
        FROM QKJ_R_ORDER T
        JOIN sys_user u on (t.userid=u.USER_ID)
        join sys_user addu on (addu.USER_ID=t.adduser)
        left join sys_user cheu on (cheu.user_id=t.approver)
        WHERE 1=1
        <if test="params.name != null and params.name.trim() != ''">
            AND u.REAL_NAME LIKE '%${params.name}%'
        </if>
        <if test="params.number != null and params.number.trim() != ''">
            AND t.number LIKE '%${params.number}%'
        </if>
        <if test="params.id != null and params.id.trim() != ''">
            AND T.ID='${params.id}'
        </if>

        <if test="params.stsdate != null and params.stsdate.trim() != ''">
            AND T.stsdate='${params.stsdate}'
        </if>

        <if test="params.source != null">
            AND T.source='${params.source}'
        </if>

        <if test="params.state != null">
            AND T.state>=${params.state} AND T.state  &lt;8
        </if>
    </sql>

    <sql id="selectSqlCount">
        SELECT count(1) as countnum
        FROM QKJ_R_ORDER T
        JOIN sys_user u on (t.userid=u.USER_ID)
        join sys_user addu on (addu.USER_ID=t.adduser)
        left join sys_user cheu on (cheu.user_id=t.approver)
        WHERE 1=1
        <if test="params.name != null and params.name.trim() != ''">
            AND cheu.REAL_NAME LIKE '%${params.name}%'
        </if>
        <if test="params.id != null and params.id.trim() != ''">
            AND T.ID='${params.id}'
        </if>

        <if test="params.source != null">
            AND T.source='${params.source}'
        </if>

        <if test="params.state != null">
            AND T.state>=${params.state} AND T.state  &lt;8
        </if>
    </sql>

    <select id="selectQkjROrderPage" resultType="com.platform.modules.qkj.entity.QkjROrderEntity">
        <include refid="selectSql"/>
    </select>

    <select id="pageCount" resultType="com.platform.modules.qkj.entity.QkjROrderEntity">
        <include refid="selectSqlCount"/>
    </select>

    <select id="queryAll" resultType="com.platform.modules.qkj.entity.QkjROrderEntity">
        <include refid="selectSql"/>
    </select>

    <update id="updateStateById" parameterType="com.platform.modules.qkj.entity.QkjROrderEntity">
		UPDATE QKJ_R_ORDER SET state = #{state},approver=#{approver},uploadad=#{uploadad} WHERE id = #{id}
	</update>

    <update id="sureBatchById">
        UPDATE QKJ_R_ORDER SET state=2 WHERE id IN
        <foreach item="ids" collection="array" open="(" separator="," close=")">
            #{ids}
        </foreach>
    </update>

    <update id="updateStateById2">
        UPDATE QKJ_R_ORDER SET state=#{state} WHERE id = #{id}
    </update>

    <update id="updateStateBySend">
        update QKJ_R_ORDER set state=
        CASE when (
        SELECT count(1) from (SELECT
        case when IfNULL(sendnum,0) &lt; IFNULL(num,0) then 1
        else 0 end as isover

        from qkj_r_sonorder where orderid=#{id}) a
        where a.isover=1)>0 then 5
        else 6 end
        where id=#{id}
    </update>

</mapper>