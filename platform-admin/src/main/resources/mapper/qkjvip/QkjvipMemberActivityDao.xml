<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.platform.modules.qkjvip.dao.QkjvipMemberActivityDao">

    <sql id="selectSql">
        SELECT
        T.*,u.REAL_NAME realname,
        (SELECT count(1) from qkjvip_member_activitymbs mb where mb.activity_id=t.id group by mb.activity_id)
        as activeper,
        (SELECT count(1) from qkjvip_member_signup sgn
        where sgn.acitvity_id=t.id group by sgn.acitvity_id
        ) as signper
        FROM QKJVIP_MEMBER_ACTIVITY T
        join sys_user u on (u.USER_ID=t.adduser)
        WHERE 1=1
        <if test="params.title != null and params.title.trim() != ''">
            AND T.title LIKE '%${params.title}%'
        </if>
        <if test="params.id != null and params.id.trim() != ''">
            AND T.NAME = '${params.id}'
        </if>
        <if test="params.memberId != null and params.memberId.trim() != ''">
            AND EXISTS (SELECT 1 from qkjvip_member_signupmember b where b.activity_id=T.id and b.member_id=#{params.memberId})
        </if>
        <if test="params.memberIdSign != null and params.memberIdSign.trim() != ''">
            AND EXISTS (SELECT 1 from qkjvip_member_signup b where b.acitvity_id=T.id and b.memberid=#{params.memberIdSign})
        </if>
        <if test="params.memberIdSignAddress != null and params.memberIdSignAddress.trim() != ''">
            OR (not EXISTS (SELECT 1 from qkjvip_member_signup b where b.acitvity_id=T.id and b.memberid=#{params.memberIdSign})
            and  EXISTS (SELECT 1 from qkjvip_member_signupaddress adres
            where adres.activityid=t.id and adres.address like '%${params.memberIdSignAddress}%')
            )
        </if>
    </sql>

    <sql id="selectSqlSignAddress">
        select * ,
        (SELECT top 1 address from qkjvip_member_signupaddress a where a.activityid=act.id) as addressstr

        from (SELECT *,
        case when ISNULL((
        SELECT top 1 sme.id from qkjvip_member_signupmember sme where sme.activity_id=t.id
        and sme.member_id in (SELECT member_id from qkjvip_member mb where mb.member_id=#{params.memberIdSign} or mb.memberidto=#{params.memberIdSign})
        ),'')='' then 0
        else 1 end as istake

        from QKJVIP_MEMBER_ACTIVITY t
        where 1=1
        <if test="params.memberIdSign != null and params.memberIdSign.trim() != ''">
            AND EXISTS (SELECT 1 from qkjvip_member_signup s where s.acitvity_id=t.id and
            (s.memberid=#{params.memberIdSign}
            or EXISTS(SELECT 1 from qkjvip_member m
            where m.member_id=s.memberid and ISNULL(m.memberidto, '88')!='88'
            and m.memberidto=#{params.memberIdSign})
            )
            )
        </if>
        union all
        SELECT *,2 istake from QKJVIP_MEMBER_ACTIVITY t
        where 1=1
        <if test="params.memberIdSign != null and params.memberIdSign.trim() != ''">
            AND not EXISTS (SELECT 1 from qkjvip_member_signup s where s.acitvity_id=t.id and
            (s.memberid=#{params.memberIdSign}
            or EXISTS(SELECT 1 from qkjvip_member m
            where m.member_id=s.memberid and ISNULL(m.memberidto, '88')!='88'
            and m.memberidto=#{params.memberIdSign})
            )
            )

        </if>

        <if test="params.ispri != null">
            AND T.ispri = 0
            or (
            t.ispri=1 and EXISTS
            (SELECT 1 from qkjvip_member_activitymbs bc
            where t.id=bc.activity_id
            and bc.member_id in (SELECT member_id from qkjvip_member mems where mems.member_id=#{params.memberIdSign} or mems.memberidto=#{params.memberIdSign})
            )
            )
        </if>
        <if test="params.memberIdSignAddress != null and params.memberIdSignAddress.trim() != ''">
            and EXISTS (SELECT 1 from qkjvip_member_signupaddress adres
            where adres.activityid=t.id and adres.address like '%${params.memberIdSignAddress}%')
        </if>
        ) act order by act.istake asc,act.end_date desc
    </sql>

    <sql id="selectSqlCount">
        SELECT t.*,
        (SELECT ISNULL(sum(1), 0) from qkjvip_member_activitymbs m where m.activity_id=t.id) as mbsnum,
        (SELECT ISNULL(sum(1), 0) from qkjvip_member_signup s where s.acitvity_id=t.id ) as signupnum,
        (SELECT ISNULL(sum(1), 0) from qkjvip_member_signupmember sm where sm.activity_id=t.id ) as smnum
        from qkjvip_member_activity t where 1=1

        <if test="params.title != null and params.title.trim() != ''">
            AND T.title LIKE '%${params.title}%'
        </if>
        <if test="params.id != null and params.id.trim() != ''">
            AND T.NAME = '${params.id}'
        </if>
        <if test="params.memberId != null and params.memberId.trim() != ''">
            AND EXISTS (SELECT 1 from qkjvip_member_signupmember b where b.activity_id=T.id and b.member_id=#{params.memberId})
        </if>
    </sql>

    <select id="selectQkjvipMemberActivityPage" resultType="com.platform.modules.qkjvip.entity.QkjvipMemberActivityEntity">
        <include refid="selectSql"/>
    </select>

    <select id="selectQkjvipMemberActivityPageCount" resultType="com.platform.modules.qkjvip.entity.QkjvipMemberActivityEntity">
        <include refid="selectSqlCount"/>
    </select>

    <select id="queryAll" resultType="com.platform.modules.qkjvip.entity.QkjvipMemberActivityEntity">
        <include refid="selectSql"/>
    </select>

    <select id="queryAllSignAddress" resultType="com.platform.modules.qkjvip.entity.QkjvipMemberActivityEntity">
        <include refid="selectSqlSignAddress"/>
    </select>
</mapper>