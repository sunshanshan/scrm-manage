<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.platform.modules.qkjvip.dao.QkjvipMemberActivityDao">

    <sql id="selectSql">
        SELECT
        T.*
        FROM QKJVIP_MEMBER_ACTIVITY T
        WHERE 1=1
        <if test="params.name != null and params.name.trim() != ''">
            AND T.NAME LIKE '%${params.name}%'
        </if>
        <if test="params.id != null and params.id.trim() != ''">
            AND T.NAME = '${params.id}'
        </if>
        <if test="params.memberId != null and params.memberId.trim() != ''">
            AND EXISTS (SELECT 1 from qkjvip_member_signupmember b where b.activity_id=T.id and b.member_id=#{params.memberId})
        </if>
        <if test="params.memberIdSign != null and params.memberIdSign.trim() != ''">
            AND EXISTS (SELECT 1 from qkjvip_member_signup b where b.acitvity_id=T.id and b.memberid=#{params.memberIdSign})
        </if>
        <if test="params.memberIdSignAddress != null and params.memberIdSignAddress.trim() != ''">
            OR (not EXISTS (SELECT 1 from qkjvip_member_signup b where b.acitvity_id=T.id and b.memberid=#{params.memberIdSign})
            and  EXISTS (SELECT 1 from qkjvip_member_signupaddress adres
            where adres.activityid=t.id and adres.address like '%${params.memberIdSignAddress}%')
            )
        </if>
    </sql>

    <sql id="selectSqlSignAddress">
        SELECT *,1 istake from QKJVIP_MEMBER_ACTIVITY t
        where 1=1
        <if test="params.memberIdSign != null and params.memberIdSign.trim() != ''">
            AND EXISTS (SELECT 1 from qkjvip_member_signup s where s.acitvity_id=t.id and s.memberid=#{params.memberIdSign})
        </if>
        union all
        SELECT *,2 istake from QKJVIP_MEMBER_ACTIVITY t
        where 1=1
        <if test="params.memberIdSign != null and params.memberIdSign.trim() != ''">
            AND not EXISTS (SELECT 1 from qkjvip_member_signup s where s.acitvity_id=t.id and s.memberid=#{params.memberIdSign})
        </if>
        <if test="params.memberIdSignAddress != null and params.memberIdSignAddress.trim() != ''">
            and  EXISTS (SELECT 1 from qkjvip_member_signupaddress adres
            where adres.activityid=t.id and adres.address like '%${params.memberIdSignAddress}%')
        </if>
    </sql>

    <sql id="selectSqlCount">
        SELECT t.*,
        (SELECT ISNULL(sum(1), 0) from qkjvip_member_activitymbs m where m.activity_id=t.id) as mbsnum,
        (SELECT ISNULL(sum(1), 0) from qkjvip_member_signup s where s.acitvity_id=t.id ) as signupnum,
        (SELECT ISNULL(sum(1), 0) from qkjvip_member_signupmember sm where sm.activity_id=t.id ) as smnum
        from qkjvip_member_activity t where 1=1

        <if test="params.title != null and params.title.trim() != ''">
            AND T.title LIKE '%${params.title}%'
        </if>
        <if test="params.id != null and params.id.trim() != ''">
            AND T.NAME = '${params.id}'
        </if>
        <if test="params.memberId != null and params.memberId.trim() != ''">
            AND EXISTS (SELECT 1 from qkjvip_member_signupmember b where b.activity_id=T.id and b.member_id=#{params.memberId})
        </if>
    </sql>

    <select id="selectQkjvipMemberActivityPage" resultType="com.platform.modules.qkjvip.entity.QkjvipMemberActivityEntity">
        <include refid="selectSql"/>
    </select>

    <select id="selectQkjvipMemberActivityPageCount" resultType="com.platform.modules.qkjvip.entity.QkjvipMemberActivityEntity">
        <include refid="selectSqlCount"/>
    </select>

    <select id="queryAll" resultType="com.platform.modules.qkjvip.entity.QkjvipMemberActivityEntity">
        <include refid="selectSql"/>
    </select>

    <select id="queryAllSignAddress" resultType="com.platform.modules.qkjvip.entity.QkjvipMemberActivityEntity">
        <include refid="selectSqlSignAddress"/>
    </select>
</mapper>