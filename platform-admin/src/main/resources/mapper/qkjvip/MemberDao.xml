<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.platform.modules.qkjvip.dao.MemberDao">
    <sql id="selectSql">
        <if test="params.memberName != null and params.memberName != ''">
            AND m.member_name LIKE '%${params.memberName}%'
        </if>
        <if test="params.realName != null and params.realName != ''">
            AND m.real_name LIKE '%${params.realName}%'
        </if>
        <if test="params.mobile != null and params.mobile != ''">
            AND m.mobile = #{params.mobile}
        </if>
        <if test="params.sex != null and params.sex != ''">
            AND m.sex = #{params.sex}
        </if>
        <if test="params.orgNo != null and params.orgNo != ''">
            AND m.org_no = #{params.orgNo}
        </if>
        <if test="params.orgUserid != null and params.orgUserid != ''">
            AND m.org_userid = #{params.orgUserid}
        </if>
        <if test="params.memberType != null and params.memberType != ''">
            AND m.member_type = #{params.memberType}
        </if>
        <!-- 年龄区间start -->
        <if test="params.ageFrom != null and params.ageFrom != ''">
            AND m.age &gt;= #{params.ageFrom}
        </if>
        <if test="params.ageTo != null and params.ageTo != ''">
            AND m.age &lt; #{params.ageTo}
        </if>
        <!-- 年龄区间end -->
        <!-- 注册时间start -->
        <if test="params.regTimeFrom != null and params.regTimeFrom != ''">
            AND m.reg_time &gt;= #{params.regTimeFrom}
        </if>
        <if test="params.regTimeTo != null and params.regTimeTo != ''">
            AND m.reg_time &lt; #{params.regTimeTo}
        </if>
        <!-- 注册时间end -->
        <!-- 近期购买金额start -->
        <if test="params.amountfrom != null and params.amountfrom != ''">
            <if test="params.buyPeriod == 1">
                AND m.amount1 &gt;= #{params.amountfrom}
            </if>
            <if test="params.buyPeriod == 2">
                AND m.amount3 &gt;= #{params.amountfrom}
            </if>
            <if test="params.buyPeriod == 3">
                AND m.amount6 &gt;= #{params.amountfrom}
            </if>
            <if test="params.buyPeriod == 4">
                AND m.amount12 &gt;= #{params.amountfrom}
            </if>
        </if>
        <if test="params.amountto != null and params.amountto != ''">
            <if test="params.buyPeriod == 1">
                AND m.amount1 &lt; #{params.amountto}
            </if>
            <if test="params.buyPeriod == 2">
                AND m.amount3 &lt; #{params.amountto}
            </if>
            <if test="params.buyPeriod == 3">
                AND m.amount6 &lt; #{params.amountto}
            </if>
            <if test="params.buyPeriod == 4">
                AND m.amount12 &lt; #{params.amountto}
            </if>
        </if>
        <!-- 近期购买金额end -->
        <!-- 近期购买次数start -->
        <if test="params.buynumfrom != null and params.buynumfrom != ''">
            <if test="params.buyPeriod == 1">
                AND m.buynum1 &gt;= #{params.buynumfrom}
            </if>
            <if test="params.buyPeriod == 2">
                AND m.buynum3 &gt;= #{params.buynumfrom}
            </if>
            <if test="params.buyPeriod == 3">
                AND m.buynum6 &gt;= #{params.buynumfrom}
            </if>
            <if test="params.buyPeriod == 4">
                AND m.buynum12 &gt;= #{params.buynumfrom}
            </if>
        </if>
        <if test="params.buynumto != null and params.buynumto != ''">
            <if test="params.buyPeriod == 1">
                AND m.buynum1 &lt; #{params.buynumto}
            </if>
            <if test="params.buyPeriod == 2">
                AND m.buynum3 &lt; #{params.buynumto}
            </if>
            <if test="params.buyPeriod == 3">
                AND m.buynum6 &lt; #{params.buynumto}
            </if>
            <if test="params.buyPeriod == 4">
                AND m.buynum12 &lt; #{params.buynumto}
            </if>
        </if>
        <!-- 近期购买次数end -->
        <!-- 近一年客单价start-->
        <if test="params.unitpricefrom != null and params.unitpricefrom != ''">
            AND m.unitprice &gt;= #{params.unitpricefrom}
        </if>
        <if test="params.unitpriceto != null and params.unitpriceto != ''">
            AND m.unitprice &lt; #{params.unitpriceto}
        </if>
        <!-- 近一年客单价end-->
        <!-- 标签 -->
        <if test="params.conditionSql != null and params.conditionSql != ''">
            AND ${params.conditionSql}
        </if>
    </sql>
	<select id="queryAll" resultType="com.platform.modules.qkjvip.entity.MemberEntity">
        SELECT m.* FROM qkjvip_member m WHERE 1=1
        <include refid="selectSql"/>
	</select>
	<select id="selectMemberList" resultType="com.platform.modules.qkjvip.entity.MemberEntity">
        SELECT m.*,u.REAL_NAME orgUsername FROM qkjvip_member m
        LEFT JOIN sys_user u ON (m.org_userid=u.USER_ID)
        WHERE 1=1
        <include refid="selectSql"/>
	</select>
    <select id="selectMemberList2" resultType="com.platform.modules.qkjvip.entity.MemberEntity">
        SELECT m.*,u.REAL_NAME orgUsername FROM qkjvip_member m
        INNER JOIN (SELECT DISTINCT member_id FROM qkjvip_member_tags) mt ON (m.member_id=mt.member_id)
        LEFT JOIN sys_user u ON (m.org_userid=u.USER_ID)
        WHERE 1=1
        <include refid="selectSql"/>
    </select>
    <!--根据openid判断是否关注公众号：孙珊珊-->
    <!--<select id="selectMemberByOpenid" resultType="com.platform.modules.qkjvip.entity.MemberEntity">
        SELECT member_id,mobile from qkjvip_member where openid=#{params.openid} and IsUnSubscribe=0 and statusflag!=1 ORDER BY SubscribeTime desc
    </select>-->
    <select id="selectMemberByOpenid" resultType="int">
        SELECT SUM(cnt) cnt FROM (
        SELECT COUNT(*) cnt FROM qkjvip_member_fans
        WHERE OpenId = #{params.openid} AND IsUnSubscribe = 0
        UNION ALL
        SELECT COUNT(*) cnt FROM qkjvip_member_jueru
        WHERE AppOpenId = #{params.openid} AND IsSubscribe = 1) a
    </select>

    <delete id="removeByIds">
        UPDATE qkjvip_member SET statusflag = 1 WHERE member_id IN
        <foreach item="memberId" collection="array" open="(" separator="," close=")">
            #{memberId}
        </foreach>
    </delete>
</mapper>