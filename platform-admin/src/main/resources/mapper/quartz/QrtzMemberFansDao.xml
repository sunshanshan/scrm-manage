<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.platform.modules.quartz.dao.QrtzMemberFansDao">
	<select id="queryAll" resultType="com.platform.modules.quartz.entity.QrtzMemberFansEntity">
		SELECT AppId, OpenId, UnionId FROM qkjvip_member_fans
		WHERE IsUnSubscribe = 0
		<if test="params.appidstr != null and params.appidstr.trim() != ''">
			AND appid IN ${params.appidstr}
		</if>
		<if test="params.memberidstr != null and params.memberidstr.trim() != ''">
			AND crm_memberid IN ${params.memberidstr}
		</if>
		UNION
		SELECT WechatAppId AppId, AppOpenId OpenId, UnionId FROM qkjvip_member_jueru
		WHERE memberchannel = 19 and disabled=0 and IsSubscribe = 1
		<if test="params.appidstr != null and params.appidstr.trim() != ''">
			AND WechatAppId IN ${params.appidstr}
		</if>
		<if test="params.memberidstr != null and params.memberidstr.trim() != ''">
			AND crm_memberid IN ${params.memberidstr}
		</if>
	</select>

    <select id="queryList" resultType="com.platform.modules.quartz.entity.QrtzMemberFansEntity">
		SELECT mf.id,tmpmf.* FROM qkjvip_member_fans mf
		INNER JOIN tmp_qkjvip_member_fans tmpmf ON (mf.OpenId=tmpmf.OpenId AND mf.AppId=tmpmf.AppId)
	</select>

	<select id="queryByMemberIdStr" resultType="com.platform.modules.quartz.entity.QrtzMemberFansEntity">
		SELECT COUNT(*) membernum, ServiceName, AppId FROM qkjvip_member_fans
		WHERE IsUnSubscribe = 0 and crm_memberid IN ${value}
		GROUP BY ServiceName, AppId
		UNION
		SELECT COUNT(*) membernum, '天佑德青稞酒' as ServiceName, WechatAppId AppId FROM qkjvip_member_jueru
		WHERE memberchannel=19 and disabled=0 and IsSubscribe = 1
		GROUP BY ServiceName, WechatAppId
	</select>
</mapper>